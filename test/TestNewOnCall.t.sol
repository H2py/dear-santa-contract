// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Test, console} from "forge-std/Test.sol";

struct MessageContext {
    address sender;
}

interface IUniversalApp {
    function onCall(
        MessageContext calldata context,
        address zrc20,
        uint256 amount,
        bytes calldata message
    ) external;
}

contract TestNewOnCallSimulation is Test {
    function testNewOnCallSimulation() public {
        address gateway = 0x6c533f7fE93fAE114d0954697069Df33C9B74fD7;
        address universalApp = 0x3C4cE01EE55bafF1C6BB9884d5b172CdEeA43Fb3;
        address user = 0x85Aef85301d3ec6F96b935FF8961dE484A7FA77D;
        
        // CCTX에서 추출한 message
        bytes memory message = hex"010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000016000000000000000000000000085aef85301d3ec6f96b935ff8961de484a7fa77d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000006932a4c30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002968747470733a2f2f6170692e6465617273616e74612e78797a2f6d657461646174612f747265652f31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000419aad4a61ac20b8af636a83bedeb9403833f3b24140113eb832ca5235016ee32546df0cdc32b271050e17d449b700edc24ec456b88b4e488ec4b7c56caa06d09f1c00000000000000000000000000000000000000000000000000000000000000";
        
        MessageContext memory ctx = MessageContext({sender: user});
        
        // Gateway로 impersonate
        vm.prank(gateway);
        
        // 호출 시도
        console.log("Calling onCall...");
        IUniversalApp(universalApp).onCall(ctx, address(0), 0, message);
        console.log("SUCCESS!");
    }
}
